<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poll - Social Stream Ninja</title>
    <link rel="icon" href="./icons/favicon.ico" />
    <link rel="preload" href="./thirdparty/NotoColorEmoji.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #0000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .poll-container {
            background-color: #FFF;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            min-width: 300px;
        }

        h2, h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        .poll-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .option-label {
            flex: 1;
            min-width: 50px;
        }

        .poll-bar {
            height: 20px;
            background-color: #3498db;
            border-radius: 10px;
            transition: width 1s ease;
        }

        .poll-bar-container {
            flex: 2;
            margin-left: 10px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .percentage {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="poll-container">
        <h2 id="poll-title">#HASHTAG POLL</h2>
        <h3 id="poll-description">Enter a hashtagged word into chat to vote for it!</h3>
        <div class="poll" id="poll">
            <!-- Poll options will be dynamically added here -->
        </div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let pollType = urlParams.get('pollType') || 'freeform';
        let pollQuestion = urlParams.get('pollQuestion') || 'Enter a hashtagged word into chat to vote for it!';
        let pollOptions = urlParams.get('pollOptions') ? urlParams.get('pollOptions').split(',') : [];
        let pollTimer = urlParams.get('pollTimer') || 60;

        document.getElementById('poll-title').innerText = pollType === 'freeform' ? '#HASHTAG POLL' : pollQuestion;
        document.getElementById('poll-description').innerText = pollQuestion;

        let results = {};
        let totalVotes = 0;

        function updatePoll(results) {
            const poll = document.getElementById('poll');
            poll.innerHTML = ''; // Clear previous poll options
            Object.keys(results).forEach(label => {
                let votes = results[label];
                let percentage = ((votes / totalVotes) * 100).toFixed(2) + '%';

                let option = document.createElement('div');
                option.className = 'poll-option';

                let optionLabel = document.createElement('span');
                optionLabel.className = 'option-label';
                optionLabel.innerText = label;

                let barContainer = document.createElement('div');
                barContainer.className = 'poll-bar-container';

                let bar = document.createElement('div');
                bar.className = 'poll-bar';
                bar.style.width = percentage;

                barContainer.appendChild(bar);

                let percentageText = document.createElement('span');
                percentageText.className = 'percentage';
                percentageText.innerText = percentage;

                option.appendChild(optionLabel);
                option.appendChild(barContainer);
                option.appendChild(percentageText);

                poll.appendChild(option);
            });
        }

        function processData(data) {
            let vote = data.chatmessage.trim().toUpperCase();
            if (pollType === 'yesno') {
                if (vote === 'YES' || vote === 'NO') {
                    results[vote] = results[vote] ? results[vote] + 1 : 1;
                    totalVotes++;
                    updatePoll(results);
                }
            } else if (pollType === 'multiple') {
                if (pollOptions.includes(vote)) {
                    results[vote] = results[vote] ? results[vote] + 1 : 1;
                    totalVotes++;
                    updatePoll(results);
                }
            } else {
                let hashtag = vote.match(/#(\w+)/);
                if (hashtag) {
                    hashtag = hashtag[1];
                    results[hashtag] = results[hashtag] ? results[hashtag] + 1 : 1;
                    totalVotes++;
                    updatePoll(results);
                }
            }
        }

        var iframe = document.createElement("iframe");
        iframe.src = "https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&notmobile&notmobile&password=false&solo&view=" + urlParams.get('session') + "&novideo&noaudio&label=dock&cleanoutput&room=" + urlParams.get('session');
        iframe.style.width = "0px";
        iframe.style.height = "0px";
        iframe.style.position = "fixed";
        iframe.style.left = "-100px";
        iframe.style.top = "-100px";
        iframe.id = "frame1";
        document.body.appendChild(iframe);

        var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
        var eventer = window[eventMethod];
        var messageEvent = eventMethod === "attachEvent" ? "onmessage" : "message";

        eventer(messageEvent, function (e) {
            if (e.source != iframe.contentWindow) return;
            if ("dataReceived" in e.data) {
                if ("overlayNinja" in e.data.dataReceived) {
                    processData(e.data.dataReceived.overlayNinja);
                }
            }
        });

    </script>
</body>
</html>
